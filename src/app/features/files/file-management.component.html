<div class="file-management-container">
  <div class="file-management-layout">
    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="header-section">
        <h2 class="text-xl font-bold">مدیریت فایل‌ها</h2>
        <div class="flex gap-2">
          <div class="view-mode-buttons">
            <button
              nz-button
              nzType="default"
              nzSize="small"
              [nzType]="viewMode() === 'list' ? 'primary' : 'default'"
              (click)="setViewMode('list')"
              title="نمایش لیستی"
            >
              <span nz-icon nzType="unordered-list" nzTheme="outline"></span>
            </button>
            <button
              nz-button
              nzType="default"
              nzSize="small"
              [nzType]="viewMode() === 'icon' ? 'primary' : 'default'"
              (click)="setViewMode('icon')"
              title="نمایش آیکون"
            >
              <span nz-icon nzType="appstore" nzTheme="outline"></span>
            </button>
            <button
              nz-button
              nzType="default"
              nzSize="small"
              [nzType]="viewMode() === 'thumbnail' ? 'primary' : 'default'"
              (click)="setViewMode('thumbnail')"
              title="نمایش تصویر بندانگشتی"
            >
              <span nz-icon nzType="picture" nzTheme="outline"></span>
            </button>
          </div>
          <button nz-button nzType="primary" (click)="showUploadModal.set(true)">
            <span nz-icon nzType="upload" nzTheme="outline"></span>
            آپلود فایل
          </button>
        </div>
      </div>

      <!-- Files Display -->
      <div class="files-section">
        @if (files().length === 0 && !pending()) {
          <div class="empty-state">
            <span nz-icon nzType="file" nzTheme="outline" class="empty-icon"></span>
            <p class="empty-text">فایلی یافت نشد</p>
          </div>
        }

        @if (viewMode() === 'list') {
          <!-- List View -->
          <div class="file-list">
            @for (file of files(); track file.id) {
              <div class="file-item-list">
                <div class="file-info">
                  <span nz-icon [nzType]="getFileIcon(file)" nzTheme="outline" class="file-icon"></span>
                  <div class="file-details">
                    <div class="file-name">{{ file.fileName }}</div>
                    <div class="file-meta">
                      <span>{{ formatFileSize(file.fileSize) }}</span>
                      <span class="divider">•</span>
                      <span>{{ file.registerDate | date: 'yyyy/MM/dd HH:mm' }}</span>
                    </div>
                  </div>
                </div>
                <div class="file-actions">
                  <button nz-button nzType="text" nzSize="small" (click)="downloadFile(file)" title="دانلود">
                    <span nz-icon nzType="download" nzTheme="outline"></span>
                  </button>
                  <button
                    nz-button
                    nzType="text"
                    nzSize="small"
                    nzDanger
                    nz-popconfirm
                    nzPopconfirmTitle="آیا مطمئن هستید که می‌خواهید این فایل را حذف کنید؟"
                    (nzOnConfirm)="deleteFile(file)"
                    title="حذف"
                  >
                    <span nz-icon nzType="delete" nzTheme="outline"></span>
                  </button>
                </div>
              </div>
            }
          </div>
        }

        @if (viewMode() === 'icon' || viewMode() === 'thumbnail') {
          <!-- Icon/Thumbnail View -->
          <div class="file-grid">
            @for (file of files(); track file.id) {
              <div class="file-item-grid">
                @if (viewMode() === 'thumbnail' && isImageFile(file)) {
                  <div class="file-thumbnail">
                    <img [src]="getFileThumbnailUrl(file)" [alt]="file.originalFileName" class="thumbnail-image" />
                  </div>
                } @else {
                  <div class="file-icon-large">
                    <span nz-icon [nzType]="getFileIcon(file)" nzTheme="outline"></span>
                  </div>
                }
                <div class="file-name-grid">{{ file.originalFileName }}</div>
                <div class="file-meta-grid">
                  <span>{{ formatFileSize(file.fileSize) }}</span>
                  <span>{{ file.registerDate | date: 'yyyy/MM/dd' }}</span>
                </div>
                <div class="file-actions-grid">
                  <button nz-button nzType="text" nzSize="small" (click)="downloadFile(file)" title="دانلود">
                    <span nz-icon nzType="download" nzTheme="outline"></span>
                  </button>
                  <button
                    nz-button
                    nzType="text"
                    nzSize="small"
                    nzDanger
                    nz-popconfirm
                    nzPopconfirmTitle="آیا مطمئن هستید که می‌خواهید این فایل را حذف کنید؟"
                    (nzOnConfirm)="deleteFile(file)"
                    title="حذف"
                  >
                    <span nz-icon nzType="delete" nzTheme="outline"></span>
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- Sidebar -->
    <div class="folder-sidebar">
      <div class="sidebar-header">
        <h3 class="text-lg font-semibold">پوشه‌ها</h3>
        <button nz-button nzType="primary" nzSize="small" (click)="openCreateFolderModal()">
          <span nz-icon nzType="plus" nzTheme="outline"></span>
        </button>
      </div>
      <div class="tree-wrapper">
        <nz-tree
          [nzData]="folderTree()"
          [nzSelectedKeys]="currentFolderId() ? [currentFolderId()!.toString()] : []"
          (nzClick)="onFolderTreeSelect($event)"
          [nzBlockNode]="true"
        >
          <ng-template #nzTreeTemplate let-node>
              <!-- <nz-dropdown [nzTrigger]="'click'" nzPlacement="bottomRight">
                <button nz-button nzType="text" nzSize="small" class="tree-node-menu" (click)="$event.stopPropagation()">
                  <span nz-icon nzType="more" nzTheme="outline"></span>
                </button>
                <ul nz-menu class="folder-context-menu">
                  <li nz-menu-item (click)="openEditFolderModalFromTree(node); $event.stopPropagation()">
                    <span nz-icon nzType="edit" nzTheme="outline"></span>
                    ویرایش
                  </li>
                  <li nz-menu-item (click)="openCreateSubfolderFromTree(node); $event.stopPropagation()">
                    <span nz-icon nzType="folder-add" nzTheme="outline"></span>
                    ایجاد زیرپوشه
                  </li>
                  <li nz-menu-divider></li>
                  <li nz-menu-item nzDanger (click)="deleteFolderFromTreeDirect(node); $event.stopPropagation()">
                    <span nz-icon nzType="delete" nzTheme="outline"></span>
                    حذف
                  </li>
                </ul>
              </nz-dropdown> -->
            <div class="tree-node-wrapper">
              <span class="tree-node-title">{{ node.title }}</span>

              <button
                nz-button
                nzType="text"
                nzSize="small"
                nz-dropdown
                [nzDropdownMenu]="folderMenu"
                nzTrigger="click"
                nzPlacement="bottomRight"
                (click)="$event.stopPropagation()"
              >
                <span nz-icon nzType="more"></span>
              </button>
              <nz-dropdown-menu #folderMenu="nzDropdownMenu">
                <ul nz-menu class="folder-context-menu">
                  <li nz-menu-item (click)="openEditFolderModalFromTree(node)">
                    <span nz-icon nzType="edit"></span>
                    ویرایش
                  </li>

                  <li nz-menu-item (click)="openCreateSubfolderFromTree(node)">
                    <span nz-icon nzType="folder-add"></span>
                    ایجاد زیرپوشه
                  </li>

                  <li nz-menu-divider></li>

                  <li nz-menu-item nzDanger (click)="deleteFolderFromTreeDirect(node)">
                    <span nz-icon nzType="delete"></span>
                    حذف
                  </li>
               </ul>
              </nz-dropdown-menu>
            </div>

          </ng-template>
        </nz-tree>
      </div>
      @if (currentFolderId()) {
        <div class="selected-folder-actions">
          <button nz-button nzType="text" nzSize="small" (click)="openEditFolderModal(currentFolderId()!)">
            <span nz-icon nzType="edit" nzTheme="outline"></span>
            ویرایش
          </button>
          <button nz-button nzType="text" nzSize="small" (click)="openCreateFolderModal(currentFolderId()!)">
            <span nz-icon nzType="folder-add" nzTheme="outline"></span>
            زیرپوشه
          </button>
          <button nz-button nzType="text" nzSize="small" nzDanger (click)="deleteFolderFromTree(currentFolderId()!)">
            <span nz-icon nzType="delete" nzTheme="outline"></span>
            حذف
          </button>
        </div>
      }
    </div>
  </div>

  <!-- Upload Modal -->
  <nz-modal
    [nzVisible]="showUploadModal()"
    (nzVisibleChange)="showUploadModal.set($event)"
    nzTitle="آپلود فایل"
    (nzOnCancel)="showUploadModal.set(false)"
    (nzOnOk)="uploadFile()"
    [nzOkLoading]="uploadPending()"
  >
    <ng-container *nzModalContent>
      <div class="mb-4">
        <label class="block mb-2">انتخاب فایل</label>
        <input
          type="file"
          class="w-full"
          (change)="onFileSelected($event)"
          accept="*/*"
        />
        @if (selectedFile) {
        <div class="mt-2 text-sm text-gray-600">
          فایل انتخاب شده: {{ selectedFile.name }}
          ({{ formatFileSize(selectedFile.size) }})
        </div>
        }
      </div>
    </ng-container>
  </nz-modal>

  <!-- Folder Modal -->
  <nz-modal
    [nzVisible]="showFolderModal()"
    (nzVisibleChange)="showFolderModal.set($event)"
    [nzTitle]="editingFolderId() ? 'ویرایش پوشه' : 'ایجاد پوشه جدید'"
    (nzOnCancel)="showFolderModal.set(false)"
    (nzOnOk)="saveFolder()"
    [nzOkLoading]="pending()"
  >
    <ng-container *nzModalContent>
      <nz-form-item>
        <nz-form-label>نام پوشه</nz-form-label>
        <nz-form-control>
          <input nz-input [ngModel]="newFolderName()" (ngModelChange)="newFolderName.set($event)" placeholder="نام پوشه را وارد کنید" />
        </nz-form-control>
      </nz-form-item>
    </ng-container>
  </nz-modal>
</div>
